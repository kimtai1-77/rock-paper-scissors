<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles.css">
    <script defer src="../script.js"></script>
    <title>Rps-display</title>

    <!--Press start 2P-->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Schibsted+Grotesk:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
</head>
<body>
    <!--<div class="nav">
        <svg xmlns="http://www.w3.org/2000/svg" height="28px" viewBox="0 -960 960 960" width="28px" fill="#35527a"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg>
    </div>-->
    <div class="display-outer">
        <div class="main selector display">
            <div class="input-cont-display">
                <span><p id="player-choice"></p></span>
                <p id="computer-choice"></p>
                <p id="roundResult"></p>
                <div id="scoreboard">
                    <h3>SCOREBOARD</h3>
                    <pre id="scoreboard-body"></pre>
                </div>
            </div>
        </div>    
        <button id="play-again">Play again</button>
        <div>
            <div class="arrows">     
                <svg xmlns="http://www.w3.org/2000/svg" id="arrow-down" height="44px" viewBox="0 -960 960 960" width="44px" fill="#b38d57"><path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/></svg>
                <svg xmlns="http://www.w3.org/2000/svg" id="arrow-up" class="hidden" height="44px" viewBox="0 -960 960 960" width="44px" fill="#b38d57"><path d="M480-528 296-344l-56-56 240-240 240 240-56 56-184-184Z"/></svg>
            </div>
            <div class="buttons-outer hidden">
                <button data-set="start-over">Start over</button>
                <button data-set="switch">Switch mode</button>
            </div>
            <div id="switchMode" class="modal">
                <div class="modal-content">
                    <p id="switchMessage"></p>
                    <div class="modal-buttons">
                        <button id="confirmSwitch">Yes</button>
                        <button id="cancelSwitch">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>        
    <script>
        window.addEventListener("DOMContentLoaded", () => {

            // Reference modal and elements
            const switchModal = document.getElementById("switchMode");
            const switchMessage = document.getElementById("switchMessage");
            const confirmBtn = document.getElementById("confirmSwitch");
            const cancelBtn = document.getElementById("cancelSwitch");
            const switchButton = document.querySelector('[data-set="switch"]'); // your trigger button
            const startOver = document.querySelector('[data-set="start-over"]');

            // when the start over btn is clicked
            startOver.addEventListener("click", () => {
                window.location.href = "../index.html";
           });

            // When the switch button is clicked, open the modal
            switchButton.addEventListener("click", () => {
                // Read current mode from sessionStorage (default to "single" if not set)
                const currentMode = sessionStorage.getItem("mode") || "single";

                // Set the message depending on mode
                if (currentMode === "multi") {
                    switchMessage.textContent = "Switch to single player?";
                } else {
                    switchMessage.textContent = "Switch to multi player?";
                }

                // Show the modal
                switchModal.style.display = "block";
            });

            // Handle "Yes" button
            confirmBtn.addEventListener("click", () => {
                const currentMode = sessionStorage.getItem("mode") || "single";

                // Flip the mode
                if (currentMode === "multi") {
                sessionStorage.setItem("mode", "single");
                // Redirect to single player start page
                window.location.href = "./start.html";
            } else {
                sessionStorage.setItem("mode", "multi");
                // Redirect to multiplayer start page
                window.location.href = "./player-start.html";
                }
            });

            // Handle "Cancel" button
            cancelBtn.addEventListener("click", () => {
                // Hide the modal again
                switchModal.style.display = "none";
            });
        });



        window.addEventListener("DOMContentLoaded", () => {
        // 1. Read choices from the URL
        const params = new URLSearchParams(window.location.search);
        const mode = params.get("mode"); // "single" or "multi"
        const player1Name = params.get("player1");
        const player2Name = params.get("player2");
        const player1Choice = params.get("player1Choice");
        const player2Choice = params.get("player2Choice"); 
        const compChoice = params.get("compChoice");

        // 2. Read scores from sessionStorage (or start at 0)
        let player1Wins = parseInt(sessionStorage.getItem("player1Wins")) || 0;   
        let player2Wins = parseInt(sessionStorage.getItem("player2Wins")) || 0;     
        let computerWins = parseInt(sessionStorage.getItem("computerWins")) || 0;
        let ties = parseInt(sessionStorage.getItem("ties")) || 0;

        // 3. Run one round using functions from script.js
            // first, check if round has already been processed
        const roundProcessed = sessionStorage.getItem("roundProcessed");

        let result; 
        if (!roundProcessed) {
            if (mode === "multi") { 
                result = getWinner(player1Choice, player2Choice); 
                if (result === "player1") {
                    player1Wins++; 
                    sessionStorage.setItem("player1Wins", player1Wins);
                } else if (result === "player2") { 
                    player2Wins++; 
                    sessionStorage.setItem("player2Wins", player2Wins);
                } else { 
                    ties++; 
                    sessionStorage.setItem("ties", ties); 
                } 
            sessionStorage.setItem("roundProcessed", "true");
            } else { 
                result = getWinner(player1Choice, compChoice); 
                if (result === "player1") { 
                    player1Wins++; 
                    sessionStorage.setItem("player1Wins", player1Wins); 
                } else if (result === "player2") { 
                    computerWins++;
                    sessionStorage.setItem("computerWins", computerWins); 
                } else { 
                    ties++;
                    sessionStorage.setItem("ties", ties);
                }
            sessionStorage.setItem("roundProcessed", "true");
            }
        } else {
            // if round processed, read last result
            result = sessionStorage.getItem("lastResult");
        }
        // store last result
        sessionStorage.setItem("lastResult", result);

        // 4. Update the DOM
        if (mode === "multi") {
            document.querySelector("#player-choice").textContent = `${player1Name} chose: ${player1Choice}`;
            document.querySelector("#computer-choice").textContent = `${player2Name} chose: ${player2Choice}`;
            
            //show round result
            document.querySelector("#roundResult").innerHTML =
            result === "player1" 
             ? `<img src="../images/winning cat emoji.png" class="emoji-character animate" alt="Mascot"> ${player1Name} wins this round!`
             : result === "player2" 
             ? `<img src="../images/winning cat emoji.png" class="emoji-character animate" alt="Mascot"> ${player2Name} wins this round!`
            : `ðŸ˜¤ It's a tie!`;


            //show scores 
            const labelsMulti = [player1Name, player2Name, "Ties"];
            const maxLengthMulti = Math.max(...labelsMulti.map(l => l.length));
            
            const p1Line = labelsMulti[0].padEnd(maxLengthMulti, " ") + ": " + player1Wins;
            const p2Line = labelsMulti[1].padEnd(maxLengthMulti, " ") + ": " + player2Wins;
            const tiesLine = labelsMulti[2].padEnd(maxLengthMulti, " ") + ": " + ties;

            document.querySelector("#scoreboard-body").textContent =
            p1Line + "\n" +
            p2Line + "\n\n" +
            tiesLine;

        } else {
            //show choices
            document.querySelector("#player-choice").textContent = "You chose: " + player1Choice;
            document.querySelector("#computer-choice").textContent = "Computer chose: " + compChoice;

            //show round result
            document.querySelector("#roundResult").innerHTML =
                result === "player1" ? `<img src="../images/winning cat emoji.png" class="emoji-character animate" alt="Mascot"> You win this round!` :
                result === "player2" ? "Computer wins this round!" :
                "It's a tie!";

            // show scores (single mode)
            const labelsSingle = ["You", "Computer", "Ties"];
            const maxLengthSingle = Math.max(...labelsSingle.map(l => l.length));
            
            const youLine = labelsSingle[0].padEnd(maxLengthSingle, " ") + ": " + player1Wins;
            const compLine = labelsSingle[1].padEnd(maxLengthSingle, " ") + ": " + computerWins;
            const tiesLine = labelsSingle[2].padEnd(maxLengthSingle, " ") + ": " + ties;

            document.querySelector("#scoreboard-body").textContent =
                youLine + "\n" +
                compLine + "\n\n" +
                tiesLine;
        }

        // 5. Wire up Play Again button
        const playAgainBtn = document.querySelector("#play-again");
        
        if (playAgainBtn) {
            playAgainBtn.addEventListener("click", () => {
                // reset the flag so the next round can run
                sessionStorage.removeItem("roundProcessed");

                if (mode === "multi") {
                    // back to player 1 selection
                    window.location.href = `./player-1-selection.html?player1=${encodeURIComponent(player1Name)}&player2=${encodeURIComponent(player2Name)}&mode=multi`;
                } else {
                window.location.href = "./start.html?single-player-name=Ok";
                }
                });
            }
        });

        // 
    </script>
</body>
</html>